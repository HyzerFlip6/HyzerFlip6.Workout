<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Workout Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import the Inter font for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fallback for browsers that don't support image */
            color: #c9d1d9; /* Light gray text for readability */
            background-image: url('https://storage.googleapis.com/gcs-sandbox-uploade-storage/image_9ec2f0.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed; /* Ensures the background stays put on scroll */
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        /* Custom scrollbar styling for a cleaner look */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: #21262d;
        }
        body::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 4px;
        }
        body::-webkit-scrollbar-thumb:hover {
            background-color: #484f58;
        }
        
        /* Frosted glass effect on cards */
        .frosted-card {
            backdrop-filter: blur(20px) saturate(200%);
            -webkit-backdrop-filter: blur(20px) saturate(200%);
            background-color: rgba(255, 255, 255, 0.05); /* Lighter, more transparent background */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle white border */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Removed .card-green for dynamic body part colors */
        .text-green-accent {
            color: #22c55e; /* Match accent color for text */
        }
        
        /* Custom styles for the submit button with frosted effect */
        .submit-button {
            /* Frosted glass effect */
            backdrop-filter: blur(20px) saturate(200%);
            -webkit-backdrop-filter: blur(20px) saturate(200%);
            background-color: rgba(0, 188, 212, 0.4); /* Teal color with 40% opacity */
            color: white;
            transition: all 0.3s ease-in-out;
        }
        .submit-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 188, 212, 0.4);
        }
        .submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Custom modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #161b22;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #30363d;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .close-button {
            color: #c9d1d9;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            color: #22c55e;
            text-decoration: none;
            cursor: pointer;
        }

        /* Styles for the workout bubbles */
        .workout-bubble {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 9999px; /* full rounded */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%; /* Ensure they are responsive */
            color: white; /* Ensure text is white for contrast */
            position: relative; /* Needed for positioning the Level Up button */
        }

        /* --- Level Up State --- */
        .workout-bubble.level-up {
            background-color: #F3F4F6; /* Bright, light gray */
            color: #161b22; /* Dark text for contrast */
            box-shadow: 0 4px 20px rgba(243, 244, 246, 0.4);
        }
        .workout-bubble .level-up-btn {
            position: absolute;
            top: 50%; /* Center vertically */
            right: 15px; /* Position from the right */
            transform: translateY(-50%); /* Adjust for vertical centering */
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 9999px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .workout-bubble .level-up-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        .workout-bubble.level-up .level-up-btn {
            background-color: rgba(0, 0, 0, 0.2); /* Darker button on light background */
            color: #161b22;
        }
        .workout-bubble.level-up .level-up-btn:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }

        /* --- J's New Blue Theme Bubbles --- */
        .bubble-j-pb { /* J's PB - Brightest Blue */
            background-color: #58CCED; /* 58CCED */
        }
        .bubble-j-current-1 { /* J's 1 Rep Current - Lighter Blue */
            background-color: #3895D3; /* 3895D3 */
        }
        .bubble-j-current-10 { /* J's 10 Rep Current - Darker Blue */
            background-color: #1261A0; /* 1261A0 */
        }
        .bubble-j-current-overall { /* J's Abs/Cardio Current (general current) */
            background-color: #3895D3; /* 3895D3 */
        }

        /* --- H's New Green Theme Bubbles --- */
        .bubble-h-pb { /* H's PB - Brightest Green */
            background-color: #319B72; /* 319B72 */
        }
        .bubble-h-current-1 { /* H's 1 Rep Current - Lighter Green */
            background-color: #267355; /* 267355 */
        }
        .bubble-h-current-10 { /* H's 10 Rep Current - Darker Green */
            background-color: #1A4C39; /* 1A4C39 */
        }
        .bubble-h-current-overall { /* H's Abs/Cardio Current (general current) */
            background-color: #267355; /* 267355 */
        }

        /* --- J & H Combined Bubbles (Teal Theme) --- */
        .bubble-jandh-current-overall { /* J & H Combined Current */
            background-color: rgba(45, 212, 191, 0.8); 
        }


        /* Styles for the initial selection buttons */
        .initial-button {
            backdrop-filter: blur(20px) saturate(200%);
            -webkit-backdrop-filter: blur(20px) saturate(200%);
            background-color: rgba(45, 65, 85, 0.4); /* Darker grey-blue for unselected state */
            color: white;
            transition: all 0.3s ease-in-out;
            padding: 1rem 2.5rem; /* Medium size */
            font-weight: 600; /*semibold*/
            border-radius: 9999px; /* full rounded */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .initial-button:hover:not(.selected-initial-button) {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(45, 65, 85, 0.4);
        }

        /* Specific colors when selected */
        .initial-button.initial-j.selected-initial-button {
            background-color: #3895D3; /* New Blue for J when selected */
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(56, 149, 211, 0.4);
        }
        .initial-button.initial-h.selected-initial-button {
            background-color: #267355; /* New Green for H when selected */
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(38, 115, 85, 0.4);
        }

        .initial-button.initial-jandh.selected-initial-button {
            background-color: rgba(0, 188, 212, 0.8); /* Reverted to Teal for J & H */
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 188, 212, 0.4); /* Reverted to Teal shadow */
        }

        /* Styles for the body part selection buttons */
        .body-part-button {
            backdrop-filter: blur(20px) saturate(200%);
            -webkit-backdrop-filter: blur(20px) saturate(200%);
            background-color: rgba(45, 65, 85, 0.4); /* Darker grey-blue for unselected state (matching initial buttons) */
            color: white;
            transition: all 0.3s ease-in-out;
            padding: 0.75rem 1.5rem; /* Slightly smaller than initial buttons, but still good size */
            font-weight: 600; /*semibold*/
            border-radius: 9999px; /* full rounded */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-grow: 1; /* Allow buttons to grow and fill space */
            text-align: center;
            min-width: 100px; /* Minimum width to prevent squishing */
        }

        .body-part-button:hover:not(.selected-body-part-button) {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(45, 65, 85, 0.4);
        }

        /* Specific colors when selected for each body part */
        .body-part-button[data-value="Legs"].selected-body-part-button,
        .card-legs { /* Card background for Legs */
            background-color: rgba(147, 51, 234, 0.8); /* Purple highlight */
            border-left: 12px solid rgba(147, 51, 234, 0.6); /* Thicker translucent border */
        }
        .card-legs { background-color: rgba(147, 51, 234, 0.1); }

        .body-part-button[data-value="Chest"].selected-body-part-button,
        .card-chest { /* Card background for Chest */
            background-color: rgba(234, 88, 12, 0.8); /* Orange highlight */
            border-left: 12px solid rgba(234, 88, 12, 0.6);
        }
        .card-chest { background-color: rgba(234, 88, 12, 0.1); }

        .body-part-button[data-value="Triceps"].selected-body-part-button,
        .card-triceps { /* Card background for Triceps */
            background-color: rgba(6, 182, 212, 0.8); /* Cyan highlight */
            border-left: 12px solid rgba(6, 182, 212, 0.6);
        }
        .card-triceps { background-color: rgba(6, 182, 212, 0.1); }

        .body-part-button[data-value="Shoulders"].selected-body-part-button,
        .card-shoulders { /* Card background for Shoulders */
            background-color: rgba(236, 72, 153, 0.8); /* Pink highlight */
            border-left: 12px solid rgba(236, 72, 153, 0.6);
        }
        .card-shoulders { background-color: rgba(236, 72, 153, 0.1); }

        .body-part-button[data-value="Back"].selected-body-part-button,
        .card-back { /* Card background for Back */
            background-color: rgba(220, 38, 38, 0.8); /* Red highlight */
            border-left: 12px solid rgba(220, 38, 38, 0.6);
        }
        .card-back { background-color: rgba(220, 38, 38, 0.1); }

        .body-part-button[data-value="Biceps"].selected-body-part-button,
        .card-biceps { /* Card background for Biceps */
            background-color: rgba(250, 204, 21, 0.8); /* Yellow highlight */
            border-left: 12px solid rgba(250, 204, 21, 0.6);
        }
        .card-biceps { background-color: rgba(250, 204, 21, 0.1); }

        .body-part-button[data-value="Abs"].selected-body-part-button,
        .card-abs { /* Card background for Abs */
            background-color: rgba(163, 230, 53, 0.8); /* Lime Green highlight */
            border-left: 12px solid rgba(163, 230, 53, 0.6);
        }
        .card-abs { background-color: rgba(163, 230, 53, 0.1); }

        .body-part-button[data-value="Cardio"].selected-body-part-button,
        .card-cardio { /* Card background for Cardio */
            background-color: rgba(20, 184, 166, 0.8); /* Darker Teal highlight */
            border-left: 12px solid rgba(20, 184, 166, 0.6);
        }
        .card-cardio { background-color: rgba(20, 184, 166, 0.1); }

        .clear-data-button {
            background-color: #ef4444; /* Red for danger */
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
            display: none; /* Hide the clear data button */
        }
        .clear-data-button:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.6);
        }
        .clear-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-[#0d1117] min-h-screen p-4 sm:p-8 text-[#c9d1d9]">

    <div class="container mx-auto p-4 sm:p-8 bg-[#161b22] shadow-2xl rounded-3xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-[#c9d1d9] mb-2">
            Gym Workout Tracker
        </h1>
        <p class="text-center text-[#8b949e] mb-8 max-w-lg mx-auto">
            Track your progress and celebrate your gains with your partner!
        </p>

        <!-- User ID & Connection Status -->
        <div class="frosted-card p-4 rounded-xl shadow-inner mb-8">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4"> 
                <span id="loadingStatus" class="text-sm text-[#8b949e] font-medium">Connecting...</span>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <span class="text-sm font-medium text-[#8b949e]">Who is inputting data?</span>
                    <div class="flex flex-wrap justify-center gap-4">
                        <button type="button" id="initialButtonJ" class="initial-button initial-j">J</button>
                        <button type="button" id="initialButtonH" class="initial-button initial-h">H</button>
                        <button type="button" id="initialButtonJandH" class="initial-button initial-jandh">J & H</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Workout Form -->
        <form id="achievementForm" class="frosted-card p-6 rounded-2xl shadow-lg mb-12">
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label for="bodyPartSelection" class="block text-sm font-semibold text-[#c9d1d9] mb-1">Body Part</label>
                    <!-- Replaced dropdown with buttons for body part selection -->
                    <div id="bodyPartSelection" class="flex flex-wrap justify-center gap-2">
                        <button type="button" class="body-part-button" data-value="Legs">Legs</button>
                        <button type="button" class="body-part-button" data-value="Chest">Chest</button>
                        <button type="button" class="body-part-button" data-value="Triceps">Triceps</button>
                        <button type="button" class="body-part-button" data-value="Shoulders">Shoulders</button>
                        <button type="button" class="body-part-button" data-value="Back">Back</button>
                        <button type="button" class="body-part-button" data-value="Biceps">Biceps</button>
                        <button type="button" class="body-part-button" data-value="Abs">Abs</button>
                        <button type="button" class="body-part-button" data-value="Cardio">Cardio</button>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <label for="achievementName" class="block text-sm font-semibold text-[#c9d1d9] mb-1">Workout Title</label>
                <select id="achievementName" required class="w-full px-4 py-2 border border-[#30363d] rounded-lg focus:ring-2 focus:ring-[#22c55e] focus:border-[#22c55e] transition bg-[#161b22] text-[#c9d1d9]">
                    <option value="">Select or add a workout</option>
                </select>
                <input type="text" id="newAchievementNameInput" placeholder="Enter new workout title" style="display:none;"
                       class="w-full mt-2 px-4 py-2 border border-[#30363d] rounded-lg focus:ring-2 focus:ring-[#22c55e] focus:border-[#22c55e] transition bg-[#161b22] text-[#c9d1d9]">
            </div>

            <!-- Combined Input Section for Weight/Reps/Time and Type -->
            <div class="mt-6 border-t border-[#30363d] pt-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="achievementType" class="block text-sm font-semibold text-[#c9d1d9] mb-1">Workout Type</label>
                        <select id="achievementType" required class="w-full px-4 py-2 border border-[#30363d] rounded-lg focus:ring-2 focus:ring-[#22c55e] focus:border-[#22c55e] transition bg-[#161b22] text-[#c9d1d9]">
                            <!-- Options will be dynamically updated by JavaScript -->
                            <option value="">Select type</option>
                            <option value="current-1">Current - 1 Rep</option>
                            <option value="current-10">Current - 10 Reps</option>
                        </select>
                    </div>
                    <div>
                        <label for="workoutData" id="workoutDataLabel" class="block text-sm font-semibold text-[#c9d1d9] mb-1">Weight / Time</label>
                        <input type="text" id="workoutData" placeholder="e.g., 80kg, 12 reps" required
                           class="w-full px-4 py-2 border border-[#30363d] rounded-lg focus:ring-2 focus:ring-[#22c55e] focus:border-[#22c55e] transition bg-[#161b22] text-[#c9d1d9]">
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center flex justify-center space-x-4">
                <button type="submit"
                        class="px-10 py-4 submit-button font-semibold rounded-full shadow-lg"
                        id="submitButton">
                    Add Workout
                </button>
                <button type="button"
                        class="px-10 py-4 bg-gray-600 text-white font-semibold rounded-full shadow-lg hover:bg-gray-700 transform hover:scale-105 transition duration-300 ease-in-out hidden"
                        id="cancelButton">
                    Cancel
                </button>
            </div>
        </form>

        <!-- Filter & Workout List Header -->
        <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-[#c9d1d9] mb-4 sm:mb-0">Workouts</h2>
            <!-- New separate filter dropdowns -->
            <div class="flex items-center space-x-2 flex-wrap">
                <span class="text-sm text-[#8b949e]">Filter by:</span>
                <select id="initialsFilter" class="p-2 border border-[#30363d] rounded-lg text-sm bg-[#161b22] text-[#c9d1d9] focus:ring-2 focus:ring-[#22c55e] focus:border-[#22c55e] mb-2 sm:mb-0">
                    <option value="all">All Workouts</option>
                    <option value="J">J's Workouts</option>
                    <option value="H">H's Workouts</option>
                    <option value="J & H">J & H's Workouts</option>
                </select>
                <select id="bodyPartFilter" class="p-2 border border-[#30363d] rounded-lg text-sm bg-[#161b22] text-[#c9d1d9] focus:ring-2 focus:ring-[#22c55e] focus:border-[#22c55e]">
                    <option value="all">All Body Parts</option>
                    <option value="Legs">Legs</option>
                    <option value="Chest">Chest</option>
                    <option value="Triceps">Triceps</option>
                    <option value="Shoulders">Shoulders</option>
                    <option value="Back">Back</option>
                    <option value="Biceps">Biceps</option>
                    <option value="Abs">Abs</option>
                    <option value="Cardio">Cardio</option>
                </select>
                <button id="clearFiltersButton" class="px-4 py-2 text-sm bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                    Clear
                </button>
            </div>
        </div>

        <!-- Workout List -->
        <div id="achievementList" class="space-y-6">
            <!-- Workouts will be dynamically inserted here -->
            <div class="text-center text-[#8b949e] p-8" id="emptyState">
                No workouts yet. Add your first one!
            </div>
        </div>

        <!-- Clear All Data Button (Now hidden via CSS) -->
        <div class="mt-12 text-center">
            <button id="clearAllDataButton" class="clear-data-button">
                Clear All Workout Data
            </button>
        </div>
    </div>

    <!-- Custom Modal for Alerts/Confirmation -->
    <div id="alertModal" class="modal hidden">
        <div class="modal-content frosted-card p-6 rounded-2xl">
            <span class="close-button">&times;</span>
            <p id="alertMessage" class="text-lg text-[#c9d1d9] font-semibold mb-4"></p>
            <div id="modalButtons" class="flex justify-center space-x-4">
                <button id="modalConfirmBtn" class="bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700 transition hidden">Confirm</button>
                <button id="modalCancelBtn" class="bg-gray-600 text-white px-6 py-2 rounded-full hover:bg-gray-700 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, getDoc, updateDoc, where, getDocs, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyBFupnxyxhkveIrjDIowXZm6gEKvLAJpzM",
            authDomain: "workout-536dc.firebaseapp.com",
            projectId: "workout-536dc",
            storageBucket: "workout-536dc.firebaseapp.com",
            messagingSenderId: "134715069306",
            appId: "1:134715069306:web:3985d7ae0b8de461523cc3"
        };
        console.log("Current Firebase Config:", firebaseConfig); // Log config for debugging


        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        console.log("Initial Auth Token from environment:", initialAuthToken); // Log the token

        // HTML elements
        const initialButtonJ = document.getElementById('initialButtonJ');
        const initialButtonH = document.getElementById('initialButtonH');
        const initialButtonJandH = document.getElementById('initialButtonJandH');

        const loadingStatusSpan = document.getElementById('loadingStatus');
        const achievementForm = document.getElementById('achievementForm');
        const achievementList = document.getElementById('achievementList');
        const submitButton = document.getElementById('submitButton');
        const emptyState = document.getElementById('emptyState');
        const initialsFilter = document.getElementById('initialsFilter');
        const bodyPartFilter = document.getElementById('bodyPartFilter');
        const bodyPartSelectionDiv = document.getElementById('bodyPartSelection');
        const bodyPartButtons = bodyPartSelectionDiv.querySelectorAll('.body-part-button');

        const achievementNameSelect = document.getElementById('achievementName');
        const newAchievementNameInput = document.getElementById('newAchievementNameInput');
        const workoutDataInput = document.getElementById('workoutData');
        const workoutDataLabel = document.getElementById('workoutDataLabel'); // Get reference to the label
        const cancelButton = document.getElementById('cancelButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const achievementTypeSelect = document.getElementById('achievementType');
        
        const alertModal = document.getElementById('alertModal');
        const alertMessage = document.getElementById('alertMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const modalCloseBtn = document.querySelector('.close-button');
        // Removed reference to clearAllDataButton here
        // const clearAllDataButton = document.getElementById('clearAllDataButton');


        // Firebase variables - declared globally but initialized within a function
        let app, db, auth;
        let currentUser = null;
        let isAuthReady = false; // Flag for overall app readiness after auth
        let allAchievements = [];
        let currentInitialFilter = 'all';
        let currentBodyPartFilter = 'all';
        let selectedInitial = ''; 
        let selectedBodyPart = ''; 
        let editingDocId = null;
        let isCardio = false;

        // Define initialWorkouts globally so it's accessible by seedInitialData
        const initialWorkouts = [
            // Legs
            { name: 'Leg Press', initial: 'J', bodyPart: 'Legs', type: 'current-1', workoutData: '200kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 25, couldPushFurther: false },
            { name: 'Leg Press', initial: 'H', bodyPart: 'Legs', type: 'current-1', workoutData: '450kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 25 + 1, couldPushFurther: false },
            { name: 'Leg Press', initial: 'J', bodyPart: 'Legs', type: 'current-10', workoutData: '180kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 24, couldPushFurther: false },
            { name: 'Leg Press', initial: 'H', bodyPart: 'Legs', type: 'current-10', workoutData: '340kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 24 + 1, couldPushFurther: false },

            { name: 'Single Leg Press', initial: 'J', bodyPart: 'Legs', type: 'current-10', workoutData: '65kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 23, couldPushFurther: false },
            { name: 'Single Leg Press', initial: 'H', bodyPart: 'Legs', type: 'current-10', workoutData: '100kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 23 + 1, couldPushFurther: false },

            { name: 'Hip Thrust', initial: 'J', bodyPart: 'Legs', type: 'current-10', workoutData: '60kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 22, couldPushFurther: false },
            { name: 'Hip Thrust', initial: 'H', bodyPart: 'Legs', type: 'current-10', workoutData: '70kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 22 + 1, couldPushFurther: false },

            { name: 'Leg Extension', initial: 'J', bodyPart: 'Legs', type: 'current-10', workoutData: '40kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 21, couldPushFurther: false },
            { name: 'Leg Extension', initial: 'H', bodyPart: 'Legs', type: 'current-10', workoutData: '75kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 21 + 1, couldPushFurther: false },

            { name: 'Hamstring Curl', initial: 'J', bodyPart: 'Legs', type: 'current-10', workoutData: '27.5kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 20, couldPushFurther: false },
            { name: 'Hamstring Curl', initial: 'H', bodyPart: 'Legs', type: 'current-10', workoutData: '55.5kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 20 + 1, couldPushFurther: false },

            { name: 'Seated Leg Curl', initial: 'J', bodyPart: 'Legs', type: 'current-10', workoutData: '40kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 19, couldPushFurther: false },
            { name: 'Seated Leg Curl', initial: 'H', bodyPart: 'Legs', type: 'current-10', workoutData: '75kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 19 + 1, couldPushFurther: false },
            
            { name: 'Abductor', initial: 'J', bodyPart: 'Legs', type: 'current-10', workoutData: '20.5kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 18, couldPushFurther: false },
            { name: 'Abductor', initial: 'H', bodyPart: 'Legs', type: 'current-10', workoutData: '36kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 18 + 1, couldPushFurther: false },

            { name: 'Adductor', initial: 'J', bodyPart: 'Legs', type: 'current-10', workoutData: '63kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 17, couldPushFurther: false },
            { name: 'Adductor', initial: 'H', bodyPart: 'Legs', type: 'current-10', workoutData: '70kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 17 + 1, couldPushFurther: false },

            // Chest
            { name: 'Bench Press', initial: 'J', bodyPart: 'Chest', type: 'current-1', workoutData: '30kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 16, couldPushFurther: false },
            { name: 'Bench Press', initial: 'H', bodyPart: 'Chest', type: 'current-1', workoutData: '115kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 16 + 1, couldPushFurther: false },
            { name: 'Bench Press', initial: 'J', bodyPart: 'Chest', type: 'current-10', workoutData: '25kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 15, couldPushFurther: false },
            { name: 'Bench Press', initial: 'H', bodyPart: 'Chest', type: 'current-10', workoutData: '85kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 15 + 1, couldPushFurther: false },
            // Current 10-rep (example for lower value than PB)
            { name: 'Bench Press', initial: 'J', bodyPart: 'Chest', type: 'current-10', workoutData: '22.5kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 14, couldPushFurther: false },
            { name: 'Bench Press', initial: 'H', bodyPart: 'Chest', type: 'current-10', workoutData: '80kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 14 + 1, couldPushFurther: false },

            { name: 'Incline Bench', initial: 'J', bodyPart: 'Chest', type: 'current-10', workoutData: '7kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 13, couldPushFurther: false },
            { name: 'Incline Bench', initial: 'H', bodyPart: 'Chest', type: 'current-10', workoutData: '30kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 13 + 1, couldPushFurther: false },
            
            { name: 'Chest Fly', initial: 'J', bodyPart: 'Chest', type: 'current-10', workoutData: '25kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 12, couldPushFurther: false },
            { name: 'Chest Fly', initial: 'H', bodyPart: 'Chest', type: 'current-10', workoutData: '86kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 12 + 1, couldPushFurther: false },
            
            // Triceps
            { name: 'Assisted Dips', initial: 'J', bodyPart: 'Triceps', type: 'current-10', workoutData: '47kg assisted', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 11, couldPushFurther: false },
            { name: 'Assisted Dips', initial: 'H', bodyPart: 'Triceps', type: 'current-10', workoutData: 'bodyweight (0kg)', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 11 + 1, couldPushFurther: false },

            // Shoulders
            { name: 'Shoulder Press', initial: 'J', bodyPart: 'Shoulders', type: 'current-10', workoutData: '7kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 10, couldPushFurther: false },
            { name: 'Shoulder Press', initial: 'H', bodyPart: 'Shoulders', type: 'current-10', workoutData: '25kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 10 + 1, couldPushFurther: false },

            // Back
            { name: 'Lat Pulldowns', initial: 'J', bodyPart: 'Back', type: 'current-10', workoutData: '25kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 9, couldPushFurther: false },
            { name: 'Lat Pulldowns', initial: 'H', bodyPart: 'Back', type: 'current-10', workoutData: '40kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 9 + 1, couldPushFurther: false },
            
            { name: 'Pull Ups', initial: 'J', bodyPart: 'Back', type: 'current-10', workoutData: '36kg assisted', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 8, couldPushFurther: false },
            { name: 'Pull Ups', initial: 'H', bodyPart: 'Back', type: 'current-10', workoutData: '8 reps', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 8 + 1, couldPushFurther: false },
            
            // Biceps
            { name: 'Preacher Curl', initial: 'J', bodyPart: 'Biceps', type: 'current-10', workoutData: '17.5kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 7, couldPushFurther: false },
            { name: 'Preacher Curl', initial: 'H', bodyPart: 'Biceps', type: 'current-10', workoutData: '45kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 7 + 1, couldPushFurther: false },
            
            { name: 'Bicep Curl', initial: 'J', bodyPart: 'Biceps', type: 'current-10', workoutData: '6kg', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 6, couldPushFurther: false },
            { name: 'Bicep Curl', initial: 'H', bodyPart: 'Biceps', type: 'current-10', workoutData: '15kg', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 6 + 1, couldPushFurther: false },

            // Abs
            { name: 'Sit Up Passes', initial: 'J & H', bodyPart: 'Abs', type: 'current-set', workoutData: '31 passes with 4kg', userId: 'seed-user-combined', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 5, couldPushFurther: false },

            // Cardio
            { name: '5km Run', initial: 'J', bodyPart: 'Cardio', type: 'current', workoutData: '34:34', userId: 'seed-user-j', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 4, couldPushFurther: false },
            { name: '5km Run', initial: 'H', bodyPart: 'Cardio', type: 'current', workoutData: '25:45', userId: 'seed-user-h', timestamp: Date.now() - 1000 * 60 * 60 * 24 * 4 + 1, couldPushFurther: false },
        ];


        /**
         * Initializes Firebase app, Firestore, and Authentication.
         * Sets up the auth state observer and handles initial seeding/listening.
         */
        async function initializeFirebaseAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app and services initialized successfully.");
                console.log("Auth object after initialization:", auth); // Log auth object

                if (!auth) {
                    throw new Error("Firebase Auth service failed to initialize within the app.");
                }

                // --- AUTHENTICATION & INITIALIZATION ---
                // Set up auth listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log('User authenticated:', user.uid);
                        currentUser = user;
                        loadingStatusSpan.textContent = "Connected and ready!";
                        loadingStatusSpan.classList.remove('text-red-500');
                        loadingStatusSpan.classList.add('text-green-500');
                        submitButton.disabled = false;
                        isAuthReady = true; // Set to true only on successful auth

                        // Seed the database with initial data, robustly
                        await seedInitialData();

                        // Listen for real-time achievements
                        listenForAchievements();
                    } else {
                        // Only attempt sign-in if no user is currently set
                        if (!currentUser) { 
                            let authSuccess = false;
                            
                            if (initialAuthToken) {
                                try {
                                    console.log("Attempting sign-in with custom token...");
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    authSuccess = true; // If this succeeds, onAuthStateChanged will be triggered.
                                } catch (customTokenError) {
                                    console.warn(`Custom token sign-in failed: ${customTokenError.code}. Falling back to anonymous sign-in.`);
                                    // Do not set error status yet, as anonymous might succeed.
                                }
                            }

                            if (!authSuccess) { // If custom token didn't succeed or wasn't attempted
                                try {
                                    console.log("Attempting anonymous sign-in...");
                                    await signInAnonymously(auth);
                                    authSuccess = true; // If this succeeds, onAuthStateChanged will be triggered.
                                } catch (anonymousError) {
                                    console.error("Anonymous sign-in also failed:", anonymousError);
                                    loadingStatusSpan.textContent = `Authentication failed: Both custom token (if attempted) and anonymous sign-in failed. Please ensure Firebase 'Anonymous' provider is enabled. Error: ${anonymousError.message}`;
                                    loadingStatusSpan.classList.remove('text-green-500');
                                    loadingStatusSpan.classList.add('text-red-500');
                                    submitButton.disabled = true;
                                    isAuthReady = false;
                                }
                            }
                            // If authSuccess is true, onAuthStateChanged will eventually fire with the user object.
                            // If it's false (meaning anonymous also failed), the error message is already set.
                        }
                    }
                });

            } catch (initError) {
                console.error("Firebase APP initialization failed:", initError);
                loadingStatusSpan.textContent = `Firebase app setup failed: ${initError.message}. Verify your firebaseConfig object and Firebase project setup.`;
                loadingStatusSpan.classList.remove('text-green-500');
                loadingStatusSpan.classList.add('text-red-500');
                submitButton.disabled = true;
                isAuthReady = false; // App initialization failed, so not ready
            }
        }


        // --- UTILITY FUNCTIONS ---
        // Function to parse workout data into a comparable numerical value
        const parseWorkoutValue = (workoutData, bodyPart) => { 
            let value = 0;

            if (bodyPart === 'Cardio') {
                // Now also parses "MM:SS" format
                const timeMatchColon = workoutData.match(/(\d+):(\d+)/); 
                if (timeMatchColon) {
                    const minutes = parseInt(timeMatchColon[1]);
                    const seconds = parseInt(timeMatchColon[2]);
                    value = (minutes * 60) + seconds;
                } else {
                    const timeMatchMinSec = workoutData.match(/(\d+)\s*min\s*(\d+)\s*sec/);
                    if (timeMatchMinSec) {
                        const minutes = parseInt(timeMatchMinSec[1]);
                        const seconds = parseInt(timeMatchMinSec[2]);
                        value = (minutes * 60) + seconds;
                    } else {
                        const singleSecondMatch = workoutData.match(/(\d+)\s*sec/);
                        if (singleSecondMatch) {
                            value = parseInt(singleSecondMatch[1]);
                        }
                    }
                }
                // For cardio PB, lower time is better, so store negative value for "max" comparison
                return -value; 
            } else {
                const weightMatch = workoutData.match(/(\d+(\.\d+)?)\s*kg/i);
                if (weightMatch) {
                    value = parseFloat(weightMatch[1]);
                } else {
                    const numMatch = workoutData.match(/(\d+(\.\d+)?)/);
                    if (numMatch) {
                        value = parseFloat(numMatch[1]);
                    }
                }
                return value;
            }
        };

        // Function to seed the database with initial workout data (more robustly)
        const seedInitialData = async () => {
            if (!isAuthReady) {
                console.log("Auth not ready, skipping seedInitialData");
                return;
            }

            const seedingMetadataCollectionPath = `artifacts/${appId}/public/data/app-metadata`;
            const seedingStatusDocRef = doc(db, seedingMetadataCollectionPath, 'seedingStatus');
            const workoutsCollectionPath = `artifacts/${appId}/public/data/gym-achievements`;
            const workoutsCollectionRef = collection(db, workoutsCollectionPath);

            try {
                const seedingStatusDoc = await getDoc(seedingStatusDocRef);

                if (seedingStatusDoc.exists() && seedingStatusDoc.data().seeded) {
                    console.log("[Seed Data] Initial data already seeded. Skipping.");
                    return; // Data already seeded, exit
                }
            } catch (e) {
                console.warn("[Seed Data Warning] Could not check seeding status, proceeding with cautious seeding. Error:", e);
                // Continue, but assume not seeded if there's an error checking status
            }

            console.log("Collection path for seeding:", workoutsCollectionPath);
            console.log("Number of initial workouts to attempt to seed:", initialWorkouts.length);

            // Fetch all existing workouts once
            console.log("[Seed Data] Fetching all existing workouts for in-memory check...");
            const existingWorkoutsSnapshot = await getDocs(workoutsCollectionRef);
            const existingWorkoutKeys = new Set();
            existingWorkoutsSnapshot.forEach(doc => {
                const data = doc.data();
                // Create a unique key for each workout to check for duplicates
                const key = `${data.name}-${data.initial}-${data.bodyPart}-${data.type}`;
                existingWorkoutKeys.add(key);
            });
            console.log(`[Seed Data] Found ${existingWorkoutKeys.size} existing unique workout entries.`);

            const batch = writeBatch(db);
            let workoutsAddedCount = 0;

            for (const workout of initialWorkouts) {
                const workoutKey = `${workout.name}-${workout.initial}-${workout.bodyPart}-${workout.type}`;
                
                if (!existingWorkoutKeys.has(workoutKey)) {
                    const calculatedPbValue = parseWorkoutValue(workout.workoutData, workout.bodyPart);
                    // Add to batch instead of direct addDoc
                    const newDocRef = doc(workoutsCollectionRef); // Create a new doc reference with an auto-generated ID
                    batch.set(newDocRef, { ...workout, calculatedPbValue });
                    workoutsAddedCount++;
                    console.log(`[Seed Data Batch] Added to batch: ${workout.initial} - ${workout.name} (${workout.type})`);
                } else {
                    // console.log(`[Seed Data] Skipped adding existing seeded document: ${workout.initial} - ${workout.name} (${workout.type}) - already exists.`);
                }
            }

            if (workoutsAddedCount > 0) {
                console.log(`[Seed Data] Committing batch for ${workoutsAddedCount} new workouts...`);
                try {
                    await batch.commit();
                    console.log(`[Seed Data] Successfully committed batch. ${workoutsAddedCount} workouts added.`);
                    // Mark as seeded after successful commit
                    await setDoc(seedingStatusDocRef, { seeded: true, timestamp: Date.now() });
                    console.log("[Seed Data] Seeding status marked as complete.");
                } catch (batchError) {
                    console.error("[Seed Data Error] Error committing batch:", batchError);
                    showModal("Error seeding initial data. See console for details.", () => {}, false);
                }
            } else {
                console.log("[Seed Data] No new initial workouts to add to batch.");
            }
            console.log("Database seeding check complete.");
        };

        // --- DATA MANAGEMENT & RENDERING ---
        // Function to listen for real-time data updates
        const listenForAchievements = () => {
            console.log("listenForAchievements called!"); // Added this log
            if (!isAuthReady) {
                console.log('Auth not ready, skipping listenForAchievements');
                return;
            }
            console.log('Firebase ready, listening for data...');
            
            const collectionPath = `artifacts/${appId}/public/data/gym-achievements`;
            const q = query(collection(db, collectionPath));
            
            onSnapshot(q, (querySnapshot) => {
                console.log('[onSnapshot] Real-time listener triggered. Documents found:', querySnapshot.docs.length);
                allAchievements = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allAchievements.push({ id: doc.id, ...data });
                });
                console.log('[onSnapshot] All achievements updated. Count:', allAchievements.length);
                console.log('[onSnapshot] All achievements data:', allAchievements); // Log the full data

                // Sort achievements alphabetically by name
                allAchievements.sort((a, b) => a.name.localeCompare(b.name));
                
                // Update dropdowns based on current selected body part (now using selectedBodyPart)
                updateAchievementNameDropdown(selectedBodyPart);
                updateWorkoutTypeDropdown(selectedBodyPart);

                // Re-render achievements with the current filters
                filterAndRenderAchievements();

            }, (error) => {
                console.error("Failed to fetch workouts:", error);
                loadingStatusSpan.textContent = "Failed to load workouts. Check console for details.";
                loadingStatusSpan.classList.add('text-red-500');
            });
        };

        // Function to update the achievement name dropdown based on the selected body part
        const updateAchievementNameDropdown = (currentSelectedBodyPart) => {
            achievementNameSelect.innerHTML = '<option value="">Select or add a workout</option>';
            const uniqueAchievementNames = new Set();
            
            // Filter achievements based on the selected body part
            const filteredAchievements = currentSelectedBodyPart === ""
                ? allAchievements
                : allAchievements.filter(ach => ach.bodyPart === currentSelectedBodyPart);

            filteredAchievements.forEach(ach => {
                if (ach.name) {
                    uniqueAchievementNames.add(ach.name);
                }
            });

            const sortedNames = Array.from(uniqueAchievementNames).sort();
            
            sortedNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                achievementNameSelect.appendChild(option);
            });
            
            // Always add the "New Workout" option last
            const newOption = document.createElement('option');
            newOption.value = 'new';
            newOption.textContent = 'New Workout';
            achievementNameSelect.appendChild(newOption);
        };
        
        // Function to update the achievement type dropdown based on the selected body part
        const updateWorkoutTypeDropdown = (currentSelectedBodyPart) => {
            isCardio = currentSelectedBodyPart === 'Cardio';
            achievementTypeSelect.innerHTML = '';
            
            let options = [];
            if (isCardio) {
                options = [
                    { value: "", text: "Select type" },
                    { value: "current", text: "Current Workout" } 
                ];
                // Updated placeholder for Cardio
                workoutDataInput.placeholder = "e.g., 25:45"; 
            } else if (currentSelectedBodyPart === 'Abs') { // Special handling for Abs with 'current-set'
                 options = [
                    { value: "", text: "Select type" },
                    { value: "current-set", text: "Current Set" }
                ];
                workoutDataInput.placeholder = "e.g., 30 passes, 4kg";
            }
            else {
                options = [
                    { value: "", text: "Select type" },
                    { value: "current-1", text: "Current - 1 Rep" },
                    { value: "current-10", text: "Current - 10 Reps" }
                ];
                workoutDataInput.placeholder = "e.g., 80kg, 12 reps";
            }
            
            options.forEach(optionData => {
                const option = document.createElement('option');
                option.value = optionData.value;
                option.textContent = optionData.text;
                achievementTypeSelect.appendChild(option);
            });
        };

        // Function to filter and render achievements based on the two separate filters
        const filterAndRenderAchievements = () => {
            console.log('[Rendering] Filtering and rendering achievements...');
            // In this function, `filteredAchievements` will not be passed directly to renderAchievements
            // Instead, renderAchievements will handle the filtering of the *fully processed* data.
            renderAchievements(); 
        };

        // Helper function to dynamically get the current PBs and latest current for a specific workout
        const getWorkoutSummaryForCategory = (workoutName, initial, bodyPart) => {
            const categoryEntries = allAchievements.filter(ach =>
                ach.name === workoutName &&
                ach.initial === initial &&
                ach.bodyPart === bodyPart
            ).sort((a, b) => b.timestamp - a.timestamp); // Sort by latest first

            let pbOverall = null;
            let currentOverall = null;
            let pb1Rep = null;
            let current1Rep = null;
            let pb10Rep = null;
            let current10Rep = null;

            if (categoryEntries.length > 0) {
                // Determine latest current for each type
                currentOverall = categoryEntries.find(ach => ach.bodyPart === 'Cardio' || ach.bodyPart === 'Abs');
                current1Rep = categoryEntries.find(ach => ach.type === 'current-1');
                current10Rep = categoryEntries.find(ach => ach.type === 'current-10');

                // Determine PBs for each type
                const overallPBs = categoryEntries.filter(ach => ach.bodyPart === 'Cardio' || ach.bodyPart === 'Abs');
                if (overallPBs.length > 0) {
                    pbOverall = overallPBs.reduce((best, current) => (current.calculatedPbValue > best.calculatedPbValue) ? current : best);
                }

                const oneRepPBs = categoryEntries.filter(ach => ach.type === 'current-1');
                if (oneRepPBs.length > 0) {
                    pb1Rep = oneRepPBs.reduce((best, current) => (current.calculatedPbValue > best.calculatedPbValue) ? current : best);
                }

                const tenRepPBs = categoryEntries.filter(ach => ach.type === 'current-10');
                if (tenRepPBs.length > 0) {
                    pb10Rep = tenRepPBs.reduce((best, current) => (current.calculatedPbValue > best.calculatedPbValue) ? current : best);
                }
            }

            return {
                pbOverall, currentOverall,
                pb1Rep, current1Rep,
                pb10Rep, current10Rep
            };
        };


        // Function to render achievements on the page
        const renderAchievements = () => {
            console.log('[DEBUG RENDER] Starting render. Full allAchievements:', JSON.stringify(allAchievements, null, 2));
            achievementList.innerHTML = '';
            
            if (allAchievements.length === 0) { // Check overall achievements for empty state
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            // 1. Group ALL achievements by name to prepare for PB/Current summary
            const groupedAchievementsForRender = allAchievements.reduce((acc, ach) => {
                const key = ach.name; // Group by workout name
                if (!acc[key]) {
                    acc[key] = {
                        name: ach.name,
                        bodyPart: ach.bodyPart,
                        J: getWorkoutSummaryForCategory(ach.name, 'J', ach.bodyPart),
                        H: getWorkoutSummaryForCategory(ach.name, 'H', ach.bodyPart),
                        'J & H': getWorkoutSummaryForCategory(ach.name, 'J & H', ach.bodyPart)
                    };
                }
                return acc;
            }, {});

            console.log('[DEBUG RENDER] groupedAchievementsForRender after summary calc:', JSON.stringify(groupedAchievementsForRender, null, 2));

            // 2. Filter the fully processed grouped achievements for rendering
            let achievementsToRender = Object.values(groupedAchievementsForRender).filter(achGroup => {
                let initialMatch = true;
                if (currentInitialFilter !== 'all') {
                    // This logic ensures that if you filter by 'J', you only see cards where 'J' has any data (current or PB).
                    initialMatch = (achGroup[currentInitialFilter]?.currentOverall || achGroup[currentInitialFilter]?.pbOverall ||
                                    achGroup[currentInitialFilter]?.current1Rep || achGroup[currentInitialFilter]?.pb1Rep ||
                                    achGroup[currentInitialFilter]?.current10Rep || achGroup[currentInitialFilter]?.pb10Rep);
                }
                let bodyPartMatch = true;
                if (currentBodyPartFilter !== 'all') {
                    bodyPartMatch = achGroup.bodyPart === currentBodyPartFilter;
                }
                return initialMatch && bodyPartMatch;
            });
            
            achievementsToRender.sort((a, b) => a.name.localeCompare(b.name));
            console.log('[DEBUG RENDER] Final achievementsToRender (filtered & sorted for display):', JSON.stringify(achievementsToRender, null, 2));


            // 3. Render these filtered, PB-calculated achievements
            achievementsToRender.forEach(ach => {
                const achievementCard = document.createElement('div');
                const bodyPartClassName = `card-${ach.bodyPart.replace(/\s+/g, '').toLowerCase()}`; // e.g., 'card-legs'
                const cardClasses = ['flex', 'flex-col', 'sm:flex-row', 'items-start', 'sm:items-center', 'justify-between', 'p-6', 'rounded-2xl', 'shadow-md', 'transition', 'duration-300', 'hover:shadow-lg', 'border', 'border-solid', 'frosted-card', bodyPartClassName];
                achievementCard.classList.add(...cardClasses);

                let detailsHtml = '';
                
                // Determine the latest overall update for edit/delete buttons and last updated info
                let latestOverallUpdate = null;
                const allRelatedWorkouts = [];
                if (ach.J.currentOverall) allRelatedWorkouts.push(ach.J.currentOverall);
                if (ach.H.currentOverall) allRelatedWorkouts.push(ach.H.currentOverall);
                if (ach['J & H'].currentOverall) allRelatedWorkouts.push(ach['J & H'].currentOverall);
                if (ach.J.current1Rep) allRelatedWorkouts.push(ach.J.current1Rep);
                if (ach.H.current1Rep) allRelatedWorkouts.push(ach.H.current1Rep);
                if (ach.J.current10Rep) allRelatedWorkouts.push(ach.J.current10Rep);
                if (ach.H.current10Rep) allRelatedWorkouts.push(ach.H.current10Rep);

                if (allRelatedWorkouts.length > 0) {
                    latestOverallUpdate = allRelatedWorkouts.reduce((latest, current) => 
                        (current && latest && current.timestamp > latest.timestamp) ? current : latest
                    );
                }

                const createInitialDetails = (initialSummary, initial, bodyPart) => {
                    let initialColor = ''; // Use hex/rgba directly
                    let headingText = '';

                    if (initial === 'J') {
                        initialColor = '#58CCED'; /* New brightest blue for J's name */
                        headingText = "J's Workouts";
                    } else if (initial === 'H') {
                        initialColor = '#319B72'; /* New brightest green for H's name */
                        headingText = "H's Workouts";
                    } else if (initial === 'J & H') {
                        initialColor = '#2DD4BF'; /* Reverted to Teal for J & H's name */
                        headingText = "J & H's Workouts";
                    }

                    let html = `<div class="mb-4 sm:mb-0 w-full sm:w-1/2">`;
                    // Apply the new dynamic color as inline style for the heading
                    html += `<h4 class="text-base font-bold mb-2" style="color: ${initialColor};">${headingText}</h4>`;
                    html += `<div class="flex flex-wrap gap-2">`;

                    if (bodyPart === 'Cardio' || bodyPart === 'Abs') {
                        const pbClass = initial === 'J' ? 'bubble-j-pb' : (initial === 'H' ? 'bubble-h-pb' : 'bubble-jandh-current-overall');
                        const currentClass = initial === 'J' ? 'bubble-j-current-overall' : (initial === 'H' ? 'bubble-h-current-overall' : 'bubble-jandh-current-overall');

                        if (initialSummary.pbOverall) {
                            html += `<div class="workout-bubble ${pbClass} text-xs px-3 py-1 text-center edit-bubble" data-id="${initialSummary.pbOverall.id}">
                                        <span class="font-bold whitespace-nowrap">PB</span>
                                        <span class="text-sm font-medium whitespace-nowrap mt-1">${initialSummary.pbOverall.workoutData}</span>
                                    </div>`;
                        }
                        // Always show current overall if it exists, regardless of PB status
                        if (initialSummary.currentOverall) { 
                            const isLevelUp = initialSummary.currentOverall.couldPushFurther ? 'level-up' : '';
                            html += `<div class="workout-bubble ${currentClass} ${isLevelUp} text-xs px-3 py-1 text-center edit-bubble" data-id="${initialSummary.currentOverall.id}">
                                        <span class="font-bold whitespace-nowrap">Current Workout</span>
                                        <span class="text-sm font-medium whitespace-nowrap mt-1">${initialSummary.currentOverall.workoutData}</span>
                                        <button class="level-up-btn" data-id="${initialSummary.currentOverall.id}">Level Up</button>
                                    </div>`;
                        }
                    } else {
                        // Non-Cardio: specific 1-Rep and 10-Rep tracking
                        
                        // --- 1-Rep Logic ---
                        const pb1RepClass = initial === 'J' ? 'bubble-j-pb' : 'bubble-h-pb';
                        const current1RepClass = initial === 'J' ? 'bubble-j-current-1' : 'bubble-h-current-1';

                        if (initialSummary.pb1Rep) {
                            html += `<div class="workout-bubble ${pb1RepClass} text-xs px-3 py-1 text-center edit-bubble" data-id="${initialSummary.pb1Rep.id}">
                                        <span class="font-bold whitespace-nowrap">1 Rep PB</span>
                                        <span class="text-sm font-medium whitespace-nowrap mt-1">${initialSummary.pb1Rep.workoutData}</span>
                                    </div>`;
                        }
                        // Always show 1 Rep Current if it exists
                        if (initialSummary.current1Rep) { 
                            const isLevelUp = initialSummary.current1Rep.couldPushFurther ? 'level-up' : '';
                            html += `<div class="workout-bubble ${current1RepClass} ${isLevelUp} text-xs px-3 py-1 text-center edit-bubble" data-id="${initialSummary.current1Rep.id}">
                                        <span class="font-bold whitespace-nowrap">1 Rep Current</span>
                                        <span class="text-sm font-medium whitespace-nowrap mt-1">${initialSummary.current1Rep.workoutData}</span>
                                        <button class="level-up-btn" data-id="${initialSummary.current1Rep.id}">Level Up</button>
                                    </div>`;
                        }

                        // --- 10-Rep Logic ---
                        const pb10RepClass = initial === 'J' ? 'bubble-j-pb' : 'bubble-h-pb'; 
                        const current10RepClass = initial === 'J' ? 'bubble-j-current-10' : 'bubble-h-current-10';

                        if (initialSummary.pb10Rep) {
                            html += `<div class="workout-bubble ${pb10RepClass} text-xs px-3 py-1 text-center edit-bubble" data-id="${initialSummary.pb10Rep.id}">
                                        <span class="font-bold whitespace-nowrap">10 Rep PB</span>
                                        <span class="text-sm font-medium whitespace-nowrap mt-1">${initialSummary.pb10Rep.workoutData}</span>
                                    </div>`;
                        }
                        if (initialSummary.current10Rep) { // Always show 10 Rep Current if it exists
                            const isLevelUp = initialSummary.current10Rep.couldPushFurther ? 'level-up' : '';
                            html += `<div class="workout-bubble ${current10RepClass} ${isLevelUp} text-xs px-3 py-1 text-center edit-bubble" data-id="${initialSummary.current10Rep.id}">
                                        <span class="font-bold whitespace-nowrap">10 Rep Current</span>
                                        <span class="text-sm font-medium whitespace-nowrap mt-1">${initialSummary.current10Rep.workoutData}</span>
                                        <button class="level-up-btn" data-id="${initialSummary.current10Rep.id}">Level Up</button>
                                    </div>`;
                        }
                    }

                    html += `</div></div>`;
                    return html;
                };
                
                // Construct details for J and H, or J & H combined
                let initialColorForCombined = '#2DD4BF'; // Reverted to Teal for J & H's name
                let headingTextForCombined = "J & H's Workouts";

                const combinedSummary = ach['J & H'];
                if (combinedSummary.currentOverall || combinedSummary.pbOverall) { // Check for either current or PB for J & H
                    detailsHtml = `
                        <div class="w-full">
                            <h4 class="text-base font-bold mb-2" style="color: ${initialColorForCombined};">${headingTextForCombined}</h4>
                            <div class="flex flex-wrap gap-2">
                                ${combinedSummary.pbOverall ? `
                                    <div class="workout-bubble bubble-jandh-current-overall text-xs px-3 py-1 text-center edit-bubble" data-id="${combinedSummary.pbOverall.id}">
                                        <span class="font-bold whitespace-nowrap">PB</span>
                                        <span class="text-sm font-medium whitespace-nowrap mt-1">${combinedSummary.pbOverall.workoutData}</span>
                                    </div>
                                ` : ''}
                                ${combinedSummary.currentOverall ? `
                                    <div class="workout-bubble bubble-jandh-current-overall ${combinedSummary.currentOverall.couldPushFurther ? 'level-up' : ''} text-xs px-3 py-1 text-center edit-bubble" data-id="${combinedSummary.currentOverall.id}">
                                        <span class="font-bold whitespace-nowrap">Current Workout</span>
                                        <span class="text-sm font-medium whitespace-nowrap mt-1">${combinedSummary.currentOverall.workoutData}</span>
                                        <button class="level-up-btn" data-id="${combinedSummary.currentOverall.id}">Level Up</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    if (ach.J.currentOverall || ach.J.pbOverall || ach.J.current1Rep || ach.J.pb1Rep || ach.J.current10Rep || ach.J.pb10Rep) {
                        detailsHtml += createInitialDetails(ach.J, 'J', ach.bodyPart);
                    }
                    if (ach.H.currentOverall || ach.H.pbOverall || ach.H.current1Rep || ach.H.pb1Rep || ach.H.current10Rep || ach.H.pb10Rep) {
                        detailsHtml += createInitialDetails(ach.H, 'H', ach.bodyPart);
                    }
                }

                const updatedBy = latestOverallUpdate?.initial;
                const updatedTime = latestOverallUpdate ? new Date(latestOverallUpdate.timestamp).toLocaleDateString() : 'N/A';
                const textColorClass = 'text-green-accent';

                const showDeleteButton = currentUser && latestOverallUpdate?.userId === currentUser.uid;
                
                let cardContent = `
                    <div class="flex-grow w-full">
                        <h3 class="text-xl font-bold text-[#c9d1d9]">${ach.name}</h3>
                        <p class="text-sm text-[#8b949e] mt-1">${ach.bodyPart}</p>
                        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-4">
                            ${detailsHtml}
                        </div>
                        <p class="text-xs text-[#8b949e] mt-4">Last updated by: <span class="font-semibold ${textColorClass}">${updatedBy}</span> on ${updatedTime}</p>
                    </div>
                    <div class="flex items-center space-x-2 mt-4 sm:mt-0">
                        ${showDeleteButton ? `
                            <button class="delete-btn px-4 py-2 text-sm font-medium bg-red-800 text-red-300 rounded-lg hover:bg-red-700 transition" data-id="${latestOverallUpdate.id}">
                                Delete
                            </button>
                        ` : ''}
                    </div>
                `;

                achievementCard.innerHTML = cardContent;
                achievementList.appendChild(achievementCard);

                // Add event listeners for delete and edit buttons after rendering
                const deleteButton = achievementCard.querySelector('.delete-btn');
                if (deleteButton) {
                    deleteButton.addEventListener('click', async (e) => {
                        try { // Added try-catch here
                            const achievementId = e.target.dataset.id;
                            console.log('[DELETE Click] ID:', achievementId, 'Target:', e.target);
                            if (isAuthReady && currentUser) {
                                showModal(`Are you sure you want to delete this workout?`, async () => {
                                    try {
                                        const collectionPath = `artifacts/${appId}/public/data/gym-achievements`;
                                        await deleteDoc(doc(db, collectionPath, achievementId));
                                        console.log('Document successfully deleted!');
                                    } catch (error) {
                                        console.error('Error removing document: ', error);
                                        showModal("Failed to delete workout. Error: " + error.message, () => {}, false);
                                    }
                                });
                            }
                        } catch (errorInDelete) {
                            console.error(`[ERROR IN EVENT LISTENER - DELETE] Error processing delete for target:`, e.target, `Error:`, errorInDelete);
                            showModal("An unexpected error occurred during deletion. See console.", () => {}, false);
                        }
                    });
                }
                
                // Add event listeners to the clickable bubbles
                const editBubbles = achievementCard.querySelectorAll('.edit-bubble');
                editBubbles.forEach(bubble => {
                    // Prevent level-up-btn clicks from triggering editWorkout
                    bubble.querySelectorAll('.level-up-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            try { // Added try-catch here
                                e.stopPropagation(); // Stop event from bubbling up to the edit-bubble
                                const workoutId = e.target.dataset.id;
                                console.log('[Level Up Click] Attempting to update couldPushFurther for ID:', workoutId, 'Target:', e.target);
                                if (isAuthReady && currentUser) {
                                    const collectionPath = `artifacts/${appId}/public/data/gym-achievements`;
                                    const docRef = doc(db, collectionPath, workoutId);
                                    
                                    // *** NEW DEFENSIVE CHECK HERE ***
                                    const currentWorkoutState = allAchievements.find(ach => ach.id === workoutId);
                                    if (!currentWorkoutState) {
                                        console.error(`[Level Up Error] Workout state not found for ID: ${workoutId}. Cannot toggle 'couldPushFurther'.`);
                                        showModal("Error: Workout data not found. Please try again.", () => {}, false);
                                        return; // Exit if state not found
                                    }

                                    const newCouldPushFurtherState = !currentWorkoutState.couldPushFurther; // Toggle state

                                    await updateDoc(docRef, { couldPushFurther: newCouldPushFurtherState });
                                    console.log(`[Level Up Success] Document ID updated: ${workoutId}, new state: ${newCouldPushFurtherState}`); 
                                    
                                    if (newCouldPushFurtherState) {
                                        showModal("Workout marked for 'Level Up' next time! Keep pushing! 💪", () => {}, false);
                                    } else { 
                                        showModal("Workout unmarked for 'Level Up'.", () => {}, false);
                                    }
                                }
                            } catch (error) {
                                console.error(`[ERROR IN EVENT LISTENER - LEVEL UP] Error updating couldPushFurther for target:`, e.target, `Error:`, error);
                                showModal("Failed to update 'Level Up' status. Error: " + error.message, () => {}, false);
                            }
                        });
                    });
                    
                    bubble.addEventListener('click', (e) => {
                        try { // Added try-catch here
                            const achievementId = e.currentTarget.dataset.id; 
                            console.log('[EDIT Click - Bubble] ID:', achievementId, 'Target:', e.currentTarget);
                            editWorkout(achievementId);
                        } catch (errorInEditBubble) {
                            console.error(`[ERROR IN EVENT LISTENER - EDIT BUBBLE] Error processing edit for target:`, e.currentTarget, `Error:`, errorInEditBubble);
                            showModal("An unexpected error occurred when trying to edit. See console.", () => {}, false);
                        }
                    });
                });
            });
        };

        // Function to handle editing an existing workout
        const editWorkout = (id) => {
            try { // Added try-catch here
                const workoutToEdit = allAchievements.find(ach => ach.id === id);
                if (!workoutToEdit) {
                    console.error('Workout to edit not found for ID:', id);
                    showModal("Workout data not found for editing.", () => {}, false);
                    return;
                }

                editingDocId = id;

                // Force select the initial and body part
                setSelectedInitialButton(workoutToEdit.initial, true); 
                setSelectedBodyPartButton(workoutToEdit.bodyPart, true); 
                
                updateAchievementNameDropdown(selectedBodyPart);
                updateWorkoutTypeDropdown(selectedBodyPart);
                updateWorkoutDataLabelAndPlaceholder(workoutToEdit.bodyPart); // Update label immediately for editing

                setTimeout(() => {
                    achievementNameSelect.value = workoutToEdit.name;
                    if (!achievementNameSelect.querySelector(`option[value="${workoutToEdit.name}"]`)) {
                        achievementNameSelect.value = 'new';
                        newAchievementNameInput.style.display = 'block';
                        newAchievementNameInput.value = workoutToEdit.name;
                    }
                }, 100);

                achievementTypeSelect.value = workoutToEdit.type;
                workoutDataInput.value = workoutToEdit.workoutData;
                
                submitButton.textContent = 'Save Changes';
                cancelButton.classList.remove('hidden');
            } catch (errorInEditWorkout) {
                console.error(`[ERROR IN EDIT WORKOUT FUNCTION] Error editing workout with ID: ${id}. Error:`, errorInEditWorkout);
                showModal("An error occurred while preparing to edit the workout. See console.", () => {}, false);
            }
        };

        // Function to reset the form state
        const resetForm = () => {
            editingDocId = null;
            achievementForm.reset();
            submitButton.textContent = 'Add Workout';
            cancelButton.classList.add('hidden');
            newAchievementNameInput.style.display = 'none';
            newAchievementNameInput.value = '';
            updateWorkoutDataLabelAndPlaceholder(''); // Reset label to default
            // Removed setSelectedBodyPartButton(''); and setSelectedInitialButton('');
            // This allows the filters to persist after form submission.
        };

        // Helper function to set the selected initial button and update its style
        // Added forceSelect parameter
        const setSelectedInitialButton = (initial, forceSelect = false) => {
            // Only toggle if not forcing a selection
            if (!forceSelect && selectedInitial === initial) {
                selectedInitial = ''; // Deselect
            } else {
                selectedInitial = initial; // Select new initial or force select
            }
            
            initialButtonJ.classList.remove('selected-initial-button');
            initialButtonH.classList.remove('selected-initial-button');
            initialButtonJandH.classList.remove('selected-initial-button');

            if (selectedInitial === 'J') {
                initialButtonJ.classList.add('selected-initial-button');
            } else if (selectedInitial === 'H') {
                initialButtonH.classList.add('selected-initial-button');
            } else if (selectedInitial === 'J & H') {
                initialButtonJandH.classList.add('selected-initial-button');
            }
            // IMPORTANT: The initial buttons now ONLY set the 'selectedInitial' state
            // and do NOT automatically update the initialsFilter dropdown or re-filter the display.
            // The initialsFilter dropdown remains the sole control for filtering the displayed cards.
            // currentInitialFilter is NOT updated here.
            // filterAndRenderAchievements() is NOT called here.
        };

        // Helper function to set the selected body part button and update its style AND filter
        // Added forceSelect parameter
        const setSelectedBodyPartButton = (bodyPart, forceSelect = false) => {
             // Only toggle if not forcing a selection
            if (!forceSelect && selectedBodyPart === bodyPart) {
                selectedBodyPart = '';
            } else {
                selectedBodyPart = bodyPart;
            }

            bodyPartButtons.forEach(button => {
                button.classList.remove('selected-body-part-button');
                // Use a dynamic class based on the body part value
                button.classList.remove('selected-body-part-Legs', 'selected-body-part-Chest', 'selected-body-part-Triceps', 
                                       'selected-body-part-Shoulders', 'selected-body-part-Back', 'selected-body-part-Biceps', 
                                       'selected-body-part-Abs', 'selected-body-part-Cardio');

                if (button.dataset.value === selectedBodyPart) {
                    button.classList.add('selected-body-part-button'); // Keep the base class for common styles
                    // Add the specific highlight class
                    button.classList.add(`selected-body-part-${selectedBodyPart.replace(/\s+/g, '')}`);
                }
            });
            updateAchievementNameDropdown(selectedBodyPart);
            updateWorkoutTypeDropdown(selectedBodyPart);
            updateWorkoutDataLabelAndPlaceholder(selectedBodyPart); // Update label AND inputmode based on selection

            // Automatically update the filter dropdown and apply filter
            bodyPartFilter.value = selectedBodyPart === '' ? 'all' : selectedBodyPart;
            currentBodyPartFilter = selectedBodyPart === '' ? 'all' : selectedBodyPart;
            filterAndRenderAchievements();
        };

        // New function to update the workout data label, placeholder, and inputmode
        const updateWorkoutDataLabelAndPlaceholder = (bodyPart) => {
            workoutDataInput.value = ''; // Clear input when body part changes
            switch (bodyPart) {
                case 'Legs':
                case 'Chest':
                case 'Triceps':
                case 'Shoulders':
                case 'Back':
                case 'Biceps':
                    workoutDataLabel.textContent = 'Weight';
                    workoutDataInput.placeholder = 'e.g., 80'; // Just number for auto-kg
                    workoutDataInput.inputmode = 'decimal'; // Numeric keyboard with decimal
                    break;
                case 'Abs':
                    workoutDataLabel.textContent = 'Reps';
                    workoutDataInput.placeholder = 'e.g., 30'; // Just number for auto-reps
                    workoutDataInput.inputmode = 'numeric'; // Numeric keyboard
                    break;
                case 'Cardio':
                    workoutDataLabel.textContent = 'Time';
                    // Updated placeholder for Cardio
                    workoutDataInput.placeholder = "e.g., 25:45"; 
                    workoutDataInput.inputmode = 'text'; // Text for mixed input (numbers, min, sec)
                    break;
                default:
                    workoutDataLabel.textContent = 'Weight / Time';
                    workoutDataInput.placeholder = 'e.g., 80kg, 12 reps';
                    workoutDataInput.inputmode = 'text'; // Default to text
                    break;
            }
        };

        // Event listener for blur to auto-append units
        workoutDataInput.addEventListener('blur', () => {
            const currentValue = workoutDataInput.value.trim();
            if (!currentValue) {
                return;
            }

            const isPureNumber = /^\d+(\.\d+)?$/.test(currentValue);
            const containsKg = /kg/i.test(currentValue);
            const containsReps = /reps/i.test(currentValue);
            // const containsMinSec = /(min|sec)/i.test(currentValue); // Not needed for auto-append for cardio

            if (['Legs', 'Chest', 'Triceps', 'Shoulders', 'Back', 'Biceps'].includes(selectedBodyPart)) {
                if (isPureNumber && !containsKg && !containsReps) {
                    workoutDataInput.value = `${currentValue}kg`;
                }
            } else if (selectedBodyPart === 'Abs') {
                if (isPureNumber && !containsReps) {
                    workoutDataInput.value = `${currentValue} reps`;
                }
            }
            // No auto-append for Cardio as per requirement for varied input.
        });
        
        // --- EVENT LISTENERS ---
        // Handle initial button clicks
        initialButtonJ.addEventListener('click', () => setSelectedInitialButton('J'));
        initialButtonH.addEventListener('click', () => setSelectedInitialButton('H'));
        initialButtonJandH.addEventListener('click', () => setSelectedInitialButton('J & H'));

        // Handle body part button clicks
        bodyPartButtons.forEach(button => {
            button.addEventListener('click', () => {
                setSelectedBodyPartButton(button.dataset.value);
            });
        });


        // Handle form submission (add or update)
        achievementForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady || !currentUser) {
                showModal("Please wait for the app to connect.", () => {}, false);
                return;
            }
            
            let achievementName = achievementNameSelect.value;
            const achievementType = achievementTypeSelect.value; 
            const workoutData = workoutDataInput.value;

            if (achievementName === 'new') {
                achievementName = newAchievementNameInput.value.trim();
                if (!achievementName) {
                    showModal("Please enter a title for the new workout.", () => {}, false);
                    return;
                }
            }

            if (!selectedInitial || !selectedBodyPart || !achievementName || !achievementType || !workoutData) {
                showModal("Please select an initial, a body part, and fill out all other fields.", () => {}, false);
                return;
            }

            const calculatedPbValue = parseWorkoutValue(workoutData, selectedBodyPart);

            const workoutDataPayload = {
                initial: selectedInitial,
                bodyPart: selectedBodyPart, 
                name: achievementName,
                type: achievementType, 
                workoutData: workoutData,
                calculatedPbValue: calculatedPbValue, 
                timestamp: Date.now(),
                userId: currentUser.uid,
                couldPushFurther: false // Default to false for new entries
            };

            const collectionPath = `artifacts/${appId}/public/data/gym-achievements`;

            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';

            try {
                if (editingDocId) {
                    const existingDoc = allAchievements.find(ach => ach.id === editingDocId);
                    if (!existingDoc) {
                        throw new Error("Document being edited not found.");
                    }

                    // Get the current PB for the specific workout type this existingDoc represents
                    const currentSummary = getWorkoutSummaryForCategory(existingDoc.name, existingDoc.initial, existingDoc.bodyPart);
                    
                    let isThisDocTheCurrentPB = false;
                    let pbValueToCompare = -Infinity; // Default for non-Cardio/Abs (higher is better)
                    let pbWorkoutData = '';

                    if (existingDoc.bodyPart === 'Cardio' || existingDoc.bodyPart === 'Abs') {
                        if (currentSummary.pbOverall) {
                            isThisDocTheCurrentPB = currentSummary.pbOverall.id === existingDoc.id;
                            pbValueToCompare = currentSummary.pbOverall.calculatedPbValue;
                            pbWorkoutData = currentSummary.pbOverall.workoutData;
                        }
                    } else if (existingDoc.type === 'current-1') {
                        if (currentSummary.pb1Rep) {
                            isThisDocTheCurrentPB = currentSummary.pb1Rep.id === existingDoc.id;
                            pbValueToCompare = currentSummary.pb1Rep.calculatedPbValue;
                            pbWorkoutData = currentSummary.pb1Rep.workoutData;
                        }
                    } else if (existingDoc.type === 'current-10') {
                        if (currentSummary.pb10Rep) {
                            isThisDocTheCurrentPB = currentSummary.pb10Rep.id === existingDoc.id;
                            pbValueToCompare = currentSummary.pb10Rep.calculatedPbValue;
                            pbWorkoutData = currentSummary.pb10Rep.workoutData;
                        }
                    }

                    if (isThisDocTheCurrentPB && calculatedPbValue < pbValueToCompare) {
                        // Scenario: User is editing *the document that currently holds the PB for this category*,
                        // and they are entering a *lower* value.
                        // According to the user: "PB should only change if current workout is higher."
                        // So, we should *not* update this PB document to a lower value.
                        // Instead, create a *new* document for this "current" workout (which is now lower than the PB).
                        
                        console.log("User submitted a lower value while editing a PB. Creating a new entry instead.");

                        let differenceMessage = "";
                        if (selectedBodyPart === 'Cardio') {
                            // For Cardio, lower time is better, so calculatedPbValue is negative.
                            // Difference should be (negative new value) - (negative old PB value) = positive difference in seconds
                            const diffSeconds = -calculatedPbValue - (-pbValueToCompare);
                            const minutes = Math.floor(diffSeconds / 60);
                            const seconds = diffSeconds % 60;
                            differenceMessage = `You're ${minutes > 0 ? `${minutes}m ` : ''}${seconds}s slower than your PB!`;
                        } else {
                            // For weight/reps, higher is better
                            const diff = pbValueToCompare - calculatedPbValue;
                            const unit = selectedBodyPart === 'Abs' ? 'reps' : 'kg';
                            differenceMessage = `You're ${diff}${unit} off your PB!`;
                        }

                        showModal(`New workout recorded! Keep pushing! 💪 ${differenceMessage}`, () => {}, false);
                        
                        await addDoc(collection(db, collectionPath), {
                            initial: selectedInitial,
                            bodyPart: selectedBodyPart,
                            name: achievementName,
                            type: achievementType,
                            workoutData: workoutData,
                            calculatedPbValue: calculatedPbValue,
                            timestamp: Date.now(), // New timestamp for this new record
                            userId: currentUser.uid,
                            couldPushFurther: false // New entry, default to false
                        });

                    } else {
                        // Regular update: either not the current PB, or it's a new PB (higher or equal value),
                        // or it's an edit to a non-PB document.
                        // In these cases, we simply update the existing document.
                        await updateDoc(doc(db, collectionPath, editingDocId), {
                            ...workoutDataPayload,
                            couldPushFurther: existingDoc.couldPushFurther // Preserve original couldPushFurther state
                        });
                        console.log("Document successfully updated!");
                        showModal("Workout successfully updated!", () => {}, false);
                    }
                } else {
                    // Always add a new document when the user clicks 'Add Workout' (not editing)
                    await addDoc(collection(db, collectionPath), workoutDataPayload);
                    console.log("Document successfully added!");
                    showModal("Workout successfully added!", () => {}, false);
                }
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showModal("Error saving workout. See console for details.", () => {}, false);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Add Workout';
                resetForm();
            }
        });

        // Handle achievementName dropdown change to show/hide the new workout input
        achievementNameSelect.addEventListener('change', (e) => {
            if (e.target.value === 'new') {
                newAchievementNameInput.style.display = 'block';
            } else {
                newAchievementNameInput.style.display = 'none';
            }
        });

        // Handle filter dropdown changes
        initialsFilter.addEventListener('change', (e) => {
            currentInitialFilter = e.target.value;
            filterAndRenderAchievements();
        });

        bodyPartFilter.addEventListener('change', (e) => {
            currentBodyPartFilter = e.target.value;
            filterAndRenderAchievements();
        });

        // Handle clear filters button click
        clearFiltersButton.addEventListener('click', () => {
            initialsFilter.value = 'all';
            bodyPartFilter.value = 'all';
            currentInitialFilter = 'all';
            currentBodyPartFilter = 'all';
            
            // NEW: Unselect the body part buttons above the form
            setSelectedBodyPartButton(''); 

            filterAndRenderAchievements();
        });

        // Handle cancel button click
        cancelButton.addEventListener('click', resetForm);

        // --- Clear All Data Logic (Now removed) ---
        // The clearAllDataButton element and its event listener is removed from the HTML and JS.
        // This ensures the button is no longer present and cannot be used.

        // --- MODAL FUNCTIONS ---
        const showModal = (message, onConfirm, isConfirm = true) => {
            alertMessage.textContent = message;
            alertModal.style.display = 'flex';
            if (isConfirm) {
                modalConfirmBtn.classList.remove('hidden');
                modalConfirmBtn.onclick = () => {
                    onConfirm();
                    alertModal.style.display = 'none';
                };
                modalCancelBtn.onclick = () => {
                    alertModal.style.display = 'none';
                };
                    } else {
                modalConfirmBtn.classList.add('hidden');
                modalCancelBtn.onclick = () => {
                    alertModal.style.display = 'none';
                };
            }
        };

        modalCloseBtn.onclick = () => {
            alertModal.style.display = 'none';
        };
        window.onclick = (event) => {
            if (event.target === alertModal) {
                alertModal.style.display = 'none';
            }
        };

        // Initialize Firebase and Auth when the script loads
        initializeFirebaseAndAuth();
    </script>
</body>
</html>
